<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BDO Grind Spots - Personal Silver/Hour</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --text-primary: #e8e8e8;
            --accent-orange: #f39c12;
            --accent-blue: #3498db;
            --accent-purple: #9b59b6;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 95%;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        /* Controls Area */
        .controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            gap: 15px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        /* Main Table Section */
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(243, 156, 18, 0.2);
            color: var(--accent-orange);
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: rgba(243, 156, 18, 0.3);
        }

        th:first-child {
            text-align: left;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border-color);
            color: #e0e0e0;
            text-align: center;
        }

        td:first-child {
            text-align: left;
            cursor: pointer;
        }

        tr.spot-row:hover td {
            background: rgba(255, 255, 255, 0.05);
        }

        tr.spot-row {
            cursor: pointer;
        }

        /* Specific text colors */
        .spot-name {
            font-weight: 600;
            color: #fff;
            text-decoration: underline;
            text-decoration-color: rgba(255, 255, 255, 0.3);
            text-underline-offset: 4px;
        }

        .positive {
            color: #2ecc71;
            font-weight: 600;
        }

        .negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .total-base {
            color: var(--accent-orange);
            font-weight: 700;
        }

        .divider {
            border-left: 2px solid rgba(243, 156, 18, 0.3);
        }

        .items-320,
        .items-370 {
            color: #fff;
            opacity: 0.9;
        }

        .total-320 {
            color: var(--accent-blue);
            font-weight: 700;
        }

        .total-370 {
            color: var(--accent-purple);
            font-weight: 700;
        }

        /* Details Panel (Hidden by default) */
        #details-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1e2a4a;
            width: 80%;
            max-width: 900px;
            max-height: 85vh;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        #details-panel.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        .panel-header {
            padding: 20px 30px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px 16px 0 0;
        }

        .panel-header h2 {
            color: white;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .close-btn:hover {
            color: white;
        }

        .panel-content {
            padding: 30px;
            overflow-y: auto;
        }

        .loot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .loot-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .loot-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .loot-item.excluded {
            opacity: 0.4;
            background: rgba(0, 0, 0, 0.2);
            text-decoration: line-through;
        }

        .item-icon {
            width: 40px;
            height: 40px;
            background: #333;
            border-radius: 6px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            display: block;
            font-weight: 600;
            color: #ddd;
            font-size: 0.95rem;
        }

        .item-price {
            display: block;
            color: var(--accent-orange);
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .item-rate {
            display: block;
            color: #888;
            font-size: 0.85rem;
            margin-top: 2px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -48%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .toggle h4 {
            margin-right: 15px;
            color: #bbb;
            font-weight: normal;
        }

        /* Edit Mode Styles */
        .btn-edit {
            background: #27ae60;
            border-color: #27ae60;
        }

        .btn-edit.active {
            background: #e67e22;
            border-color: #e67e22;
        }

        .edit-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--accent-blue);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            width: 80px;
            text-align: center;
            font-size: 0.9rem;
        }

        .edit-input:focus {
            outline: none;
            border-color: var(--accent-orange);
            background: rgba(0, 0, 0, 0.5);
        }

        /* Column Visibility */
        .hide-320 .col-320 {
            display: none !important;
        }

        .hide-370 .col-370 {
            display: none !important;
        }

        .view-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .view-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            color: #bbb;
        }

        .view-controls input[type="checkbox"] {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="overlay" id="overlay"></div>

    <div class="container">
        <h1>üí∞ BDO Grind Analytics</h1>
        <p class="subtitle">Live Market Prices & Personal Efficiency Tracker</p>

        <div class="controls">
            <div class="view-controls">
                <label>
                    <input type="checkbox" id="check320" checked onchange="toggleColumnGroup('320')"> Show 320%
                </label>
                <label>
                    <input type="checkbox" id="check370" checked onchange="toggleColumnGroup('370')"> Show 370%
                </label>
            </div>
            <button class="btn btn-edit" onclick="toggleEditMode()" id="editBtn">
                ‚úèÔ∏è Edit Mode: OFF
            </button>
            <button class="btn" onclick="updateAllPrices()" id="refreshBtn">
                üîÑ Update Market Prices
            </button>
        </div>

        <div class="section">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Spot</th>
                        <th onclick="sortTable(1)">AP/DP</th>
                        <th onclick="sortTable(2)">Garmoth TL</th>
                        <th onclick="sortTable(3)">Your TL</th>
                        <th onclick="sortTable(4)">Agris</th>
                        <th onclick="sortTable(5)">Efficiency</th>
                        <th onclick="sortTable(6)">TL Silver/H</th>
                        <th onclick="sortTable(7)">Items Silver/H</th>
                        <th onclick="sortTable(8)">Total (Base)</th>
                        <th class="divider col-320" onclick="sortTable(9)">Items (320%)</th>
                        <th class="col-320" onclick="sortTable(10)">Total (320%)</th>
                        <th class="col-320" onclick="sortTable(11)">Silver/Agris</th>
                        <th class="divider col-370" onclick="sortTable(12)">Items (370%)</th>
                        <th class="col-370" onclick="sortTable(13)">Total (370%)</th>
                        <th class="col-370" onclick="sortTable(14)">Silver/Agris</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows will be generated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Details Panel -->
    <div id="details-panel">
        <div class="panel-header">
            <h2 id="panelTitle">Spot Details</h2>
            <button class="close-btn" onclick="closePanel()">√ó</button>
        </div>
        <div class="panel-content">
            <div class="toggle-container">
                <h4>Click items to exclude/include them from potential revenue (e.g. unsellable items)</h4>
            </div>
            <div class="loot-grid" id="lootGrid">
                <!-- Items injected here -->
            </div>
        </div>
    </div>

    <style>
        .item-icon {
            width: 32px;
            height: 32px;
            margin-right: 10px;
            vertical-align: middle;
            border-radius: 4px;
            object-fit: contain;
            background-color: #2a2a2a;
        }
    </style>
    <script>
        // Database of spots and their items
        // Note: Prices will be updated from API. Base rates are approx per hour from Garmoth data.
        const db = {
            "Orzekea": {
                ap_dp: "1595 | 700",
                agris: 22000,
                garmoth_tl: 22385,
                your_tl: 22000,
                trash_price: 96000,
                items: [
                    { id: 56334, name: "Thorn-Entwined Weapon Fragment", rate: 22385, price: 96000, isTrash: true },
                    { id: 821182, name: "Gem of Void", rate: 5.91, price: 250000 },
                    { id: 11882, name: "Deboreka Earring", rate: 0.368, price: 0 },
                    { id: 12276, name: "Deboreka Belt", rate: 0.258, price: 0 },
                    { id: 768160, name: "Sealed Black Magic Crystal", rate: 18, price: 0 },
                    { id: 721003, name: "Caphras Stone", rate: 38.6, price: 0 },
                    { id: 721002, name: "Ancient Spirit Dust", rate: 86.7, price: 3000 },
                    { id: 16001, name: "Black Stone", rate: 59.5, price: 0 }
                ]
            },
            "Ash Forest": {
                ap_dp: "1540 | 540",
                agris: 30000,
                garmoth_tl: 35826,
                your_tl: 40000,
                trash_price: 53000,
                items: [
                    { id: 56322, name: "Tainted Specter's Cloth", rate: 35832, price: 53000, isTrash: true },
                    { id: 11653, name: "Deboreka Necklace", rate: 0.688, price: 0 },
                    { id: 767091, name: "Dehkia's Fragment", rate: 2.15, price: 0 },
                    { id: 721003, name: "Caphras Stone", rate: 66.9, price: 0 },
                    { id: 56284, name: "Forgotten Limbo Box", rate: 0.049, price: 10000000 },
                    { id: 15258, name: "Crystal of Stalwart Fortitude", rate: 0.0579, price: 0 },
                    { id: 748021, name: "Dehkia's Artifact - All Damage Reduction", rate: 0.0028, price: 0 },
                    { id: 748022, name: "Dehkia's Artifact - All Evasion", rate: 0.0029, price: 0 },
                    { id: 15257, name: "Crystal of Precise Destruction", rate: 0.173, price: 0 },
                    { id: 15260, name: "Crystal of Unyielding Spirit", rate: 0.0551, price: 0 },
                    { id: 15259, name: "Crystal of Dogged Patience", rate: 0.0541, price: 0 },
                    { id: 16001, name: "Black Stone", rate: 65.6, price: 0 }
                ]
            },
            "Darkseeker's Retreat": {
                ap_dp: "1490 | 540",
                agris: 27000,
                garmoth_tl: 35358,
                your_tl: 41000,
                trash_price: 46000,
                items: [
                    { id: 65330, name: "Decayed Cloth", rate: 35358, price: 46000, isTrash: true },
                    { id: 65323, name: "Essence of Devouring", rate: 1.2, price: 0 },
                    { id: 768160, name: "Sealed Black Magic Crystal", rate: 26.4, price: 0 },
                    { id: 742269, name: "Kabua's Artifact", rate: 0.019, price: 0 },
                    { id: 56284, name: "Forgotten Limbo Box", rate: 0.0614, price: 10000000 },
                    { id: 65319, name: "Origin of Dark Hunger", rate: 0.0451, price: 0 },
                    { id: 59881, name: "Kabua's Fragment", rate: 0.842, price: 1000000, excluded: true },
                    { id: 65318, name: "Embers of Resonance", rate: 0.757, price: 10000000, excluded: true },
                    { id: 65317, name: "Flame of Resonance", rate: 0.0062, price: 50000000, excluded: true },
                    { id: 16001, name: "Black Stone", rate: 57.6, price: 0 },
                    { id: 721002, name: "Ancient Spirit Dust", rate: 31.9, price: 3000 },
                    { id: 5960, name: "Trace of Nature", rate: 43, price: 0 },
                    { id: 766104, name: "Imperfect Lightstone of Fire", rate: 1.27, price: 3100000 },
                    { id: 766105, name: "Imperfect Lightstone of Earth", rate: 0.127, price: 3100000 },
                    { id: 766106, name: "Imperfect Lightstone of Wind", rate: 0.0961, price: 3000000 }
                ]
            },
            "Aetherion Castle": {
                ap_dp: "1595 | 615",
                agris: 30000,
                garmoth_tl: 19054,
                your_tl: 21500,
                trash_price: 106000,
                items: [
                    { id: 767244, name: "Chilled Soul Piece", rate: 19054, price: 106000, isTrash: true },
                    { id: 821246, name: "Primordial Fragment", rate: 4.81, price: 30000000 },
                    { id: 11882, name: "Deboreka Earring", rate: 0.218, price: 0 },
                    { id: 12276, name: "Deboreka Belt", rate: 0.111, price: 0 },
                    { id: 721003, name: "Caphras Stone", rate: 25.3, price: 0 },
                    { id: 12094, name: "Deboreka Ring", rate: 0.109, price: 0 },
                    { id: 11653, name: "Deboreka Necklace", rate: 0.106, price: 0 },
                    { id: 821253, name: "WON Crystal of Ruin", rate: 4.68, price: 5000000 },
                    { id: 721002, name: "Ancient Spirit Dust", rate: 44.7, price: 3000 },
                    { id: 15286, name: "WON Crystal of Dusky Ruin", rate: 0.0182, price: 500000000 },
                    { id: 16001, name: "Black Stone", rate: 49.8, price: 0 }
                ]
            },
            "Dokkebi Forest": {
                ap_dp: "1445 | 530",
                agris: 17000,
                garmoth_tl: 31045,
                your_tl: 37000,
                trash_price: 53000,
                items: [
                    { id: 56327, name: "Discarded Kkebicap", rate: 31046, price: 53000, isTrash: true },
                    { id: 767102, name: "Faint Origin of Dark Hunger", rate: 0.35, price: 0 },
                    { id: 15263, name: "WON Dawn Crystal - All AP", rate: 0.847, price: 0 },
                    { id: 721003, name: "Caphras Stone", rate: 27.5, price: 0 },
                    { id: 15275, name: "WON Dawn Crystal - Evasion", rate: 0.596, price: 0 },
                    { id: 15272, name: "WON Dawn Crystal - Damage Reduction", rate: 0.584, price: 0 },
                    { id: 15266, name: "WON Dawn Crystal - Black Spirit's Rage", rate: 0.589, price: 0 },
                    { id: 15269, name: "WON Dawn Crystal - Accuracy", rate: 0.577, price: 0 },
                    { id: 721002, name: "Ancient Spirit Dust", rate: 69.9, price: 3000 },
                    { id: 15262, name: "BON Dawn Crystal - All AP", rate: 0.019, price: 0 },
                    { id: 15265, name: "BON Dawn Crystal - Black Spirit's Rage", rate: 0.0183, price: 0 },
                    { id: 15268, name: "BON Dawn Crystal - Accuracy", rate: 0.0178, price: 0 },
                    { id: 15274, name: "BON Dawn Crystal - Evasion", rate: 0.0178, price: 0 },
                    { id: 15271, name: "BON Dawn Crystal - Damage Reduction", rate: 0.0169, price: 0 },
                    { id: 16001, name: "Black Stone", rate: 42.3, price: 0 }
                ]
            },
            "Orbita Castle": {
                ap_dp: "1800 | 740",
                garmoth_tl: 21122,
                your_tl: 21128,
                trash_price: 140000,
                items: [
                    { id: 767247, name: "Lightlost Core", rate: 21122, price: 140000, isTrash: true },
                    { id: 821317, name: "Distorted Fragment of Origin", rate: 1.63, price: 108000000 },
                    { id: 11882, name: "Deboreka Earring", rate: 0.196, price: 0 },
                    { id: 821252, name: "Crystallized Energy of Endtimes", rate: 4, price: 23000000 },
                    { id: 12094, name: "Deboreka Ring", rate: 0.131, price: 0 },
                    { id: 821319, name: "JIN Crystal of Ruin", rate: 5.05, price: 8000000 },
                    { id: 12276, name: "Deboreka Belt", rate: 0.0973, price: 0 },
                    { id: 721003, name: "Caphras Stone", rate: 23.6, price: 0 },
                    { id: 11653, name: "Deboreka Necklace", rate: 0.0935, price: 0 },
                    { id: 821318, name: "Silent Fragment of Origin", rate: 0.187, price: 150000000 },
                    { id: 15290, name: "JIN Crystal of Dusky Ruin", rate: 0.0256, price: 800000000 },
                    { id: 721002, name: "Ancient Spirit Dust", rate: 63.1, price: 3000 },
                    { id: 761802, name: "Distorted Crystal of Origin", rate: 0.0022, price: 5400000000 },
                    { id: 16001, name: "Black Stone", rate: 49, price: 0 },
                    { id: 761803, name: "Silent Crystal of Origin", rate: 0.0005, price: 7000000000 }
                ]
            },
            "Honglim Base": {
                ap_dp: "950 | 390",
                garmoth_tl: 36168,
                your_tl: 36168,
                trash_price: 21000, // Faded Bandit Mask
                items: [
                    { id: 56328, name: "Faded Bandit Mask", rate: 36168, price: 21000, isTrash: true },
                    { id: 767102, name: "Faint Origin of Dark Hunger", rate: 0.168, price: 0 },
                    { id: 721003, name: "Caphras Stone", rate: 28.8, price: 0 },
                    { id: 15263, name: "WON Dawn Crystal - All AP", rate: 0.362, price: 0 },
                    { id: 721002, name: "Ancient Spirit Dust", rate: 82.5, price: 3000 },
                    { id: 15275, name: "WON Dawn Crystal - Evasion", rate: 0.266, price: 0 },
                    { id: 15266, name: "WON Dawn Crystal - Black Spirit's Rage", rate: 0.265, price: 0 },
                    { id: 15272, name: "WON Dawn Crystal - Damage Reduction", rate: 0.259, price: 0 },
                    { id: 15269, name: "WON Dawn Crystal - Accuracy", rate: 0.255, price: 0 },
                    { id: 16001, name: "Black Stone", rate: 129, price: 0 },
                    { id: 15265, name: "BON Dawn Crystal - Black Spirit's Rage", rate: 0.0128, price: 0 },
                    { id: 15262, name: "BON Dawn Crystal - All AP", rate: 0.0114, price: 0 },
                    { id: 15268, name: "BON Dawn Crystal - Accuracy", rate: 0.0111, price: 0 },
                    { id: 15274, name: "BON Dawn Crystal - Evasion", rate: 0.011, price: 0 },
                    { id: 15271, name: "BON Dawn Crystal - Damage Reduction", rate: 0.0109, price: 0 }
                ]
            },
            "Nymphamere Castle": {
                ap_dp: "1690 | 720",
                garmoth_tl: 18638,
                your_tl: 18638,
                trash_price: 116000, // Contaminated Coral Piece
                items: [
                    { id: 767245, name: "Contaminated Coral Piece", rate: 18642, price: 116000, isTrash: true },
                    { id: 821317, name: "Distorted Fragment of Origin", rate: 1.32, price: 0 },
                    { id: 11882, name: "Deboreka Earring", rate: 0.152, price: 0 },
                    { id: 821252, name: "Crystallized Energy of Endtimes", rate: 3.13, price: 0 },
                    { id: 721003, name: "Caphras Stone", rate: 22.2, price: 0 },
                    { id: 12276, name: "Deboreka Belt", rate: 0.0776, price: 0 },
                    { id: 821254, name: "BON Crystal of Ruin", rate: 4.01, price: 7000000 },
                    { id: 12094, name: "Deboreka Ring", rate: 0.0769, price: 0 },
                    { id: 11653, name: "Deboreka Necklace", rate: 0.0747, price: 0 },
                    { id: 821318, name: "Silent Fragment of Origin", rate: 0.143, price: 0 },
                    { id: 15287, name: "BON Crystal of Dusky Ruin", rate: 0.0191, price: 700000000 },
                    { id: 721002, name: "Ancient Spirit Dust", rate: 42.1, price: 3000 },
                    { id: 761802, name: "Distorted Crystal of Origin", rate: 0.0022, price: 0 },
                    { id: 16001, name: "Black Stone", rate: 47.6, price: 0 },
                    { id: 761803, name: "Silent Crystal of Origin", rate: 0.0004, price: 0 }
                ]
            }
        };

        // Cache for prices
        let marketPrices = {};
        let isAscending = false;
        let currentSortCol = 13; // Default to Total (370%)
        let isEditMode = false;
        let userOverrides = {};
        let colSettings = { show320: true, show370: true };


        // Helper: Collect all unique items (prefer ID, fallback to Name)
        function getAllUniqueItems() {
            const seen = new Set();
            const uniqueList = [];

            Object.values(db).forEach(spot => {
                spot.items.forEach(i => {
                    if (i.isTrash) return;
                    // Use ID as key if possible, else Name
                    const key = i.id ? `id:${i.id}` : `name:${i.name}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueList.push({ name: i.name, id: i.id });
                    }
                });
            });
            return uniqueList;
        }

        async function fetchItemPrice(item) {
            try {
                let url;
                if (item.id) {
                    // Direct ID lookup recommended by user
                    url = `https://api.blackdesertmarket.com/item/${item.id}?region=eu&language=en-US`;
                } else {
                    // Fallback to name search
                    url = `https://api.blackdesertmarket.com/search/${encodeURIComponent(item.name)}?region=eu&language=en-US`;
                }

                const res = await fetch(url);
                const json = await res.json();

                if (json.data && json.data.length > 0) {
                    // Item endpoint returns array with 1 item. Search returns array of matches.
                    // For Search: Find exact name match first, otherwise take first result
                    if (!item.id) {
                        const exactMatch = json.data.find(d => d.name.toLowerCase() === item.name.toLowerCase());
                        return (exactMatch || json.data[0]).basePrice || 0;
                    } else {
                        // Direct ID match
                        return json.data[0].basePrice || 0;
                    }
                }
            } catch (e) {
                console.warn(`Failed to fetch price for ${item.name}:`, e);
            }
            return 0;
        }

        async function updateAllPrices() {
            const btn = document.getElementById('refreshBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Fetching Prices...';
            btn.disabled = true;

            const uniqueItems = getAllUniqueItems();
            let completed = 0;

            // Fetch in parallel
            const promises = uniqueItems.map(async (item) => {
                const price = await fetchItemPrice(item);
                if (price > 0) {
                    marketPrices[item.name] = price;
                }
                completed++;
                if (completed % 5 === 0) {
                    btn.innerHTML = `‚è≥ Fetching... ${completed}/${uniqueItems.length}`;
                }
            });

            await Promise.all(promises);

            calculateDerivedPrices();

            savePrices(); // Save to local storage

            btn.innerHTML = '‚úÖ Prices Updated';
            btn.disabled = false;
            setTimeout(() => btn.innerHTML = originalText, 2000);

            renderTable();
        }

        function calculateDerivedPrices() {
            // Calculate Ancient Spirit Dust value (Crafting: 5 ASD + 1 BS = 1 Caphras)
            const caphras = marketPrices["Caphras Stone"] || 0;
            const blackStone = marketPrices["Black Stone"] || 0;

            if (caphras > 0 && blackStone > 0) {
                // Derived value per dust
                // We use floor to be safe on profit margin
                const dustValue = Math.floor((caphras - blackStone) / 5);
                if (dustValue > 0) {
                    marketPrices["Ancient Spirit Dust"] = dustValue;
                }
            }
        }

        function savePrices() {
            localStorage.setItem('bdo_market_prices', JSON.stringify(marketPrices));
            localStorage.setItem('bdo_prices_timestamp', new Date().toLocaleString());
        }

        function loadPrices() {
            const saved = localStorage.getItem('bdo_market_prices');
            if (saved) {
                try {
                    marketPrices = JSON.parse(saved);
                    const ts = localStorage.getItem('bdo_prices_timestamp');
                    if (ts) console.log(`Loaded prices from ${ts}`);

                    // Recalculate derived prices (ASD) based on loaded data
                    calculateDerivedPrices();
                } catch (e) {
                    console.error("Failed to load saved prices", e);
                }
            }
        }

        function saveExclusions() {
            const states = {};
            Object.keys(db).forEach(spot => {
                db[spot].items.forEach(item => {
                    states[`${spot}|${item.name}`] = !!item.excluded;
                });
            });
            localStorage.setItem('bdo_item_exclusions', JSON.stringify(states));
        }

        function loadExclusions() {
            try {
                const saved = localStorage.getItem('bdo_item_exclusions');
                if (saved) {
                    const states = JSON.parse(saved);
                    Object.keys(db).forEach(spot => {
                        db[spot].items.forEach(item => {
                            const key = `${spot}|${item.name}`;
                            // Trash items should never be excluded
                            if (item.isTrash) {
                                item.excluded = false;
                            } else if (states[key] !== undefined) {
                                item.excluded = states[key];
                            }
                        });
                    });
                }
            } catch (e) {
                console.error("Failed to load exclusions", e);
            }
        }

        // --- User Overrides (TL/Agris) persistence ---
        function saveUserOverrides() {
            const overrides = {};
            Object.keys(db).forEach(spot => {
                overrides[spot] = {
                    your_tl: db[spot].your_tl,
                    agris: db[spot].agris
                };
            });
            localStorage.setItem('bdo_user_overrides', JSON.stringify(overrides));
        }

        function loadUserOverrides() {
            try {
                const saved = localStorage.getItem('bdo_user_overrides');
                if (saved) {
                    userOverrides = JSON.parse(saved);
                    Object.keys(userOverrides).forEach(spot => {
                        if (db[spot]) {
                            if (userOverrides[spot].your_tl !== undefined) db[spot].your_tl = userOverrides[spot].your_tl;
                            if (userOverrides[spot].agris !== undefined) db[spot].agris = userOverrides[spot].agris;
                        }
                    });
                }
            } catch (e) {
                console.error("Failed to load user overrides", e);
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('editBtn');
            if (isEditMode) {
                btn.classList.add('active');
                btn.innerHTML = 'üíæ Save & Exit Edit Mode';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '‚úèÔ∏è Edit Mode: OFF';
                saveUserOverrides();
            }
            renderTable();
        }

        function handleTlChange(spot, value) {
            const num = parseInt(value) || 0;
            db[spot].your_tl = num;
            // Update table without full re-render for performance if possible, 
            // but full re-render ensures all derived stats update correctly.
            renderTable();
        }

        function handleAgrisChange(spot, value) {
            const num = parseInt(value) || 0;
            db[spot].agris = num;
            renderTable();
        }

        // --- Column Visibility Logic ---
        function toggleColumnGroup(group) {
            const isChecked = document.getElementById(`check${group}`).checked;
            colSettings[`show${group}`] = isChecked;
            applyColumnVisibility();
            saveColSettings();
        }

        function applyColumnVisibility() {
            const table = document.getElementById('mainTable');

            if (!colSettings.show320) table.classList.add('hide-320');
            else table.classList.remove('hide-320');

            if (!colSettings.show370) table.classList.add('hide-370');
            else table.classList.remove('hide-370');

            // Sync checkboxes
            document.getElementById('check320').checked = colSettings.show320;
            document.getElementById('check370').checked = colSettings.show370;
        }

        function saveColSettings() {
            localStorage.setItem('bdo_col_settings', JSON.stringify(colSettings));
        }

        function loadColSettings() {
            try {
                const saved = localStorage.getItem('bdo_col_settings');
                if (saved) {
                    colSettings = JSON.parse(saved);
                    applyColumnVisibility();
                }
            } catch (e) {
                console.error("Failed to load column settings", e);
            }
        }



        function calculateSpotStats(spotName) {
            const spot = db[spotName];
            const tlSilver = spot.your_tl * spot.trash_price;

            let itemsSilverBase = 0;
            let itemsSilver320 = 0;
            let itemsSilver370 = 0;

            spot.items.forEach(item => {
                if (item.excluded || item.isTrash) return;

                // If price exists in marketPrices, use it. Otherwise use default 0.
                const price = marketPrices[item.name] || item.price || 0;

                // Base Rate (from Garmoth approximation) * Price
                // Efficiency Multiplier: (YourTL / GarmothTL)
                // If Your TL is higher, you get more items proportionately.
                const efficiency = spot.your_tl / spot.garmoth_tl;
                const adjustedRate = item.rate * efficiency;

                // Base Revenue (100% Drop Rate equivalent logic? No, rates are "Average per hour")
                // Screenshot data is "Average Silver an Hour". If drop rate event is active, 
                // it usually applies to Item Drop Rate.
                // Assuming "Base Rate" in my DB is the AVERAGE rate at normal times (or whatever Garmoth reports).
                // Garmoth usually reports averages submitted by users.
                // 
                // If user wants 320% column:
                // Base items revenue * 3.2? (Assuming base is 100%)
                // No, Garmoth data is average of mixed drop rates. This is a bit tricky.
                // BUT, user asked for "320% columns" implying a multiplier on the *quantity*.
                //
                // Simplified Logic requested by user previously:
                // "add/subtract from/to values correct % so i can see avg silver per hour for me"
                // "make the avg/silver/h +50% etc."

                // Base items revenue adjusted for kill speed
                // Apply 15.5% Central Market tax (Value Pack) to rare items (0.845 retention)
                const baseItemRev = adjustedRate * price * 0.845;

                itemsSilverBase += baseItemRev;
                // For 320% drop rate (3.2x items):
                itemsSilver320 += baseItemRev * 3.2;
                // For 370% drop rate (3.7x items):
                itemsSilver370 += baseItemRev * 3.7;
            });

            const total320 = tlSilver + itemsSilver320;
            const total370 = tlSilver + itemsSilver370;

            // Silver per Agris
            let silverPerAgris320 = 0;
            let silverPerAgris370 = 0;
            if (spot.agris) {
                silverPerAgris320 = total320 / spot.agris;
                silverPerAgris370 = total370 / spot.agris;
            }

            return {
                tlSilver,
                itemsSilverBase,
                totalBase: tlSilver + itemsSilverBase,
                itemsSilver320,
                total320,
                itemsSilver370,
                total370,
                silverPerAgris320,
                silverPerAgris370
            };
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            Object.keys(db).forEach(spot => {
                const data = db[spot];

                const efficiency = (data.your_tl - data.garmoth_tl) / data.garmoth_tl;
                const effClass = efficiency > 0 ? 'positive' : (efficiency < 0 ? 'negative' : '');
                const effText = efficiency === 0 ? '0%' : (efficiency > 0 ? '+' : '') + (efficiency * 100).toFixed(1) + '%';

                const stats = calculateSpotStats(spot);

                const row = document.createElement('tr');
                row.className = 'spot-row';
                // Clicking row opens details (except when clicking a specific interactive element, handled by bubbling)
                row.onclick = (e) => openPanel(spot);

                row.innerHTML = `
                    <td class="spot-name">${spot}</td>
                    <td>${data.ap_dp}</td>
                    <td>${data.garmoth_tl.toLocaleString()}</td>
                    <td>
                        ${isEditMode ? `<input type="number" class="edit-input" value="${data.your_tl}" onchange="handleTlChange('${spot}', this.value)" onclick="event.stopPropagation()">` : data.your_tl.toLocaleString()}
                    </td>
                    <td>
                        ${isEditMode ? `<input type="number" class="edit-input" value="${data.agris || 0}" onchange="handleAgrisChange('${spot}', this.value)" onclick="event.stopPropagation()">` : (data.agris ? data.agris.toLocaleString() : '-')}
                    </td>
                    <td class="${effClass}">${effText}</td>
                    <td>${formatBillions(stats.tlSilver)}</td>
                    <td>${formatBillions(stats.itemsSilverBase)}</td>
                    <td class="total-base">${formatBillions(stats.totalBase)}</td>
                    <td class="items-320 divider col-320">${formatBillions(stats.itemsSilver320)}</td>
                    <td class="total-320 col-320">${formatBillions(stats.total320)}</td>
                    <td class="col-320">${stats.silverPerAgris320 > 0 ? Math.floor(stats.silverPerAgris320).toLocaleString() : '-'}</td>
                    <td class="items-370 divider col-370">${formatBillions(stats.itemsSilver370)}</td>
                    <td class="total-370 col-370">${formatBillions(stats.total370)}</td>
                    <td class="col-370">${stats.silverPerAgris370 > 0 ? Math.floor(stats.silverPerAgris370).toLocaleString() : '-'}</td>
                `;
                tbody.appendChild(row);
            });

            // Re-apply current sort
            sortTable(currentSortCol, true);
        }

        function formatBillions(num) {
            if (num > 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num > 1000000) return (num / 1000000).toFixed(0) + 'M';
            return num.toLocaleString();
        }

        /* --- Panel Logic --- */
        const panel = document.getElementById('details-panel');
        const overlay = document.getElementById('overlay');
        const title = document.getElementById('panelTitle');
        const grid = document.getElementById('lootGrid');

        function openPanel(spotName) {
            title.textContent = spotName + " - Loot Table";
            grid.innerHTML = '';

            if (db[spotName].items.length === 0) {
                grid.innerHTML = '<p style="color:#888; grid-column: 1/-1; text-align:center;">No items defined for this spot yet.</p>';
            }

            db[spotName].items.forEach((item, index) => {
                // Skip trash items in detailed view? Or show them? 
                // Showing them is fine, but they aren't toggleable for "Market Price" usually.

                const el = document.createElement('div');
                el.className = 'loot-item' + (item.excluded ? ' excluded' : '');
                if (!item.isTrash) {
                    el.onclick = (e) => {
                        e.stopPropagation();
                        toggleItem(spotName, index);
                    };
                } else {
                    el.style.cursor = 'default';
                    el.style.opacity = '0.7';
                }

                // For display in modal:
                const price = item.isTrash ? item.price : (marketPrices[item.name] || item.price || 0);
                const priceSource = (marketPrices[item.name] && !item.isTrash) ? 'Market' : 'Fixed';
                const iconUrl = item.id ? `icons/${item.id}.png` : '';

                el.innerHTML = `
                    <div style="display:flex; align-items:center;"> 
                        ${iconUrl ? `<img src="${iconUrl}" class="item-icon" onerror="this.style.visibility='hidden'">` : '<div class="item-icon"></div>'}
                    </div>
                    <div class="item-details">
                        <span class="item-name">${item.name} ${item.isTrash ? '(Trash)' : ''}</span>
                        <span class="item-price">${price.toLocaleString()} Silver <small>(${priceSource})</small></span>
                        <span class="item-rate">Base Rate: ${item.rate.toLocaleString()} / hr</span>
                    </div>
                `;
                grid.appendChild(el);
            });

            panel.classList.add('active');
            overlay.classList.add('active');
        }

        function closePanel() {
            panel.classList.remove('active');
            overlay.classList.remove('active');
        }

        function toggleItem(spot, index) {
            db[spot].items[index].excluded = !db[spot].items[index].excluded;
            saveExclusions();
            openPanel(spot);
            renderTable(); // Re-calc totals immediately
        }

        overlay.onclick = closePanel;

        /* --- API Logic --- */
        // The new updateAllPrices function is already defined above.

        // Init
        loadPrices();
        loadExclusions();
        loadUserOverrides();
        loadColSettings();
        renderTable();

        function parseValue(text) {
            // Remove commas
            const clean = text.replace(/,/g, '');
            if (clean.includes('B')) {
                return parseFloat(clean.replace('B', '')) * 1_000_000_000;
            }
            if (clean.includes('M')) {
                return parseFloat(clean.replace('M', '')) * 1_000_000;
            }
            if (clean.includes('%')) {
                return parseFloat(clean.replace('%', ''));
            }
            // Also handle AP/DP (1595 | 700) -> Sort by AP
            if (clean.includes('|')) {
                return parseFloat(clean.split('|')[0].trim());
            }
            return parseFloat(clean);
        }

        function sortTable(colIndex, keepCurrent = false) {
            currentSortCol = colIndex;
            if (!keepCurrent) isAscending = !isAscending;

            const table = document.getElementById("mainTable");
            const rows = Array.from(table.tBodies[0].rows);

            rows.sort((a, b) => {
                const textA = a.cells[colIndex].innerText;
                const textB = b.cells[colIndex].innerText;

                const valA = parseValue(textA);
                const valB = parseValue(textB);

                if (isNaN(valA) || isNaN(valB)) {
                    return isAscending ? textA.localeCompare(textB) : textB.localeCompare(textA);
                }

                return isAscending ? valA - valB : valB - valA;
            });

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            rows.forEach(row => tbody.appendChild(row));
        }

    </script>
</body>

</html>